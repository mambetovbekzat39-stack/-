<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <meta name="theme-color" content="#0d1f0f" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <title>–ê–≥—Ä–æ–ö–∞—Ä—Ç–∞ KG</title>
  
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet" />
  
    <style>
        :root {
            --bg:         #0a1a0c;
            --surface:    #0f1e11;
            --panel:      #131f14;
            --card:       #192b1b;
            --card2:      #1e3320;
            --border:     #243828;
            --green:      #39e06b;
            --green-dim:  #1d5e33;
            --green-glow: rgba(57,224,107,0.15);
            --amber:      #ffb74d;
            --red:        #ff5252;
            --blue:       #4dd0e1;
            --text:       #c8e6c9;
            --text-dim:   #6a8f6a;
            --text-muted: #3d5e3d;
            --radius:     20px;
            --radius-sm:  12px;
            --safe-top: env(safe-area-inset-top, 0px);
            --safe-bottom: env(safe-area-inset-bottom, 0px);
        }

        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

        html, body {
            height: 100%; height: 100dvh;
            overflow: hidden;
            background: var(--bg);
            font-family: 'Nunito', sans-serif;
            color: var(--text);
            -webkit-tap-highlight-color: transparent;
            -webkit-font-smoothing: antialiased;
        }

        #app {
            position: relative;
            width: 100%;
            height: 100%;
            height: 100dvh;
            display: flex;
            flex-direction: column;
        }

        #map {
            flex: 1;
            width: 100%;
            min-height: 0;
            background: var(--bg);
            z-index: 1;
        }

        /* ‚îÄ‚îÄ TOP BAR ‚îÄ‚îÄ */
        .topbar {
            position: absolute;
            top: 0; left: 0; right: 0;
            z-index: 800;
            padding: calc(var(--safe-top) + 10px) 10px 0;
            display: flex;
            gap: 8px;
            align-items: center;
            pointer-events: none;
        }
        .topbar > * { pointer-events: auto; }

        .brand {
            background: rgba(15,30,17,0.93);
            backdrop-filter: blur(20px) saturate(1.5);
            -webkit-backdrop-filter: blur(20px) saturate(1.5);
            border: 1px solid var(--border);
            border-radius: 50px;
            padding: 8px 14px 8px 8px;
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
            flex-shrink: 0;
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
        }
        .brand-logo {
            width: 32px; height: 32px;
            background: linear-gradient(135deg, #39e06b, #1aaf45);
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 16px;
            flex-shrink: 0;
        }
        .brand-title {
            font-size: 0.85rem;
            font-weight: 900;
            color: var(--green);
            letter-spacing: -0.3px;
            line-height: 1.1;
        }
        .brand-sub {
            font-size: 0.6rem;
            color: var(--text-dim);
            display: block;
            font-weight: 600;
        }

        /* Search */
        .search-wrap { flex: 1; position: relative; min-width: 0; }
        .search-inner {
            display: flex;
            background: rgba(15,30,17,0.93);
            backdrop-filter: blur(20px) saturate(1.5);
            -webkit-backdrop-filter: blur(20px) saturate(1.5);
            border: 1px solid var(--border);
            border-radius: 50px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
        }
        .search-input {
            flex: 1;
            padding: 10px 14px;
            border: none;
            background: transparent;
            color: var(--text);
            font-family: 'Nunito', sans-serif;
            font-size: 0.9rem;
            font-weight: 600;
            outline: none;
            min-width: 0;
        }
        .search-input::placeholder { color: var(--text-dim); }
        .search-btn {
            padding: 10px 16px;
            border: none;
            background: var(--green);
            color: #0a1a0c;
            font-family: 'Nunito', sans-serif;
            font-weight: 800;
            font-size: 0.85rem;
            cursor: pointer;
            white-space: nowrap;
            transition: background 0.15s;
            display: flex; align-items: center; gap: 5px;
            flex-shrink: 0;
        }
        .search-btn:active { background: #2dc558; }

        .search-dropdown {
            position: absolute;
            top: calc(100% + 8px);
            left: 0; right: 0;
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            overflow: hidden;
            max-height: 280px;
            overflow-y: auto;
            display: none;
            z-index: 900;
            box-shadow: 0 12px 40px rgba(0,0,0,0.6);
        }
        .search-dropdown.active { display: block; }
        .search-item {
            padding: 14px 16px;
            font-size: 0.9rem;
            cursor: pointer;
            border-bottom: 1px solid var(--border);
            color: var(--text);
            font-weight: 600;
            transition: background 0.12s;
            line-height: 1.3;
        }
        .search-item:last-child { border-bottom: none; }
        .search-item:hover, .search-item:active { background: var(--card); }

        /* ‚îÄ‚îÄ MAP CONTROLS OVERRIDE ‚îÄ‚îÄ */
        .leaflet-control-zoom {
            border: none !important;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5) !important;
            border-radius: 14px !important;
            overflow: hidden !important;
        }
        .leaflet-control-zoom a {
            width: 48px !important; height: 48px !important;
            line-height: 48px !important;
            background: rgba(15,30,17,0.93) !important;
            color: var(--green) !important;
            border-bottom: 1px solid var(--border) !important;
            font-size: 24px !important;
        }
        .leaflet-draw-toolbar {
            border: none !important;
            border-radius: 14px !important;
            overflow: hidden !important;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5) !important;
        }
        .leaflet-draw-toolbar a {
            width: 48px !important; height: 48px !important;
            background: rgba(15,30,17,0.93) !important;
            border-bottom: 1px solid var(--border) !important;
            background-size: 26px 26px !important;
        }
        .leaflet-top.leaflet-right {
            top: calc(var(--safe-top) + 68px) !important;
        }

        /* ‚îÄ‚îÄ LAYER SWITCHER ‚îÄ‚îÄ */
        .layer-switcher {
            position: absolute;
            bottom: calc(var(--safe-bottom) + 82px);
            left: 12px;
            z-index: 500;
            display: flex;
            gap: 6px;
        }
        .layer-btn {
            padding: 11px 16px;
            border-radius: 50px;
            border: 1px solid var(--border);
            background: rgba(15,30,17,0.93);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            color: var(--text-dim);
            font-family: 'Nunito', sans-serif;
            font-size: 0.85rem;
            font-weight: 800;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 4px 16px rgba(0,0,0,0.4);
        }
        .layer-btn.active {
            background: var(--green);
            color: #0a1a0c;
            border-color: var(--green);
        }
        .layer-btn:active { transform: scale(0.95); }

        /* ‚îÄ‚îÄ NDVI LEGEND ‚îÄ‚îÄ */
        .ndvi-legend {
            position: absolute;
            right: 12px;
            bottom: calc(var(--safe-bottom) + 138px);
            z-index: 500;
            background: rgba(15,30,17,0.93);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            padding: 12px 14px;
            font-size: 0.75rem;
            font-weight: 700;
            display: none;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        }
        .ndvi-legend.visible { display: block; }
        .ndvi-legend-title { color: var(--text-dim); margin-bottom: 8px; font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.5px; }
        .legend-row { display: flex; align-items: center; gap: 8px; margin: 5px 0; color: var(--text); }
        .legend-dot { width: 10px; height: 10px; border-radius: 3px; flex-shrink: 0; }

        /* ‚îÄ‚îÄ BOTTOM PANEL ‚îÄ‚îÄ */
        .bottom-panel {
            position: absolute;
            bottom: 0; left: 0; right: 0;
            z-index: 700;
            background: var(--panel);
            border-top: 1px solid var(--border);
            border-radius: 28px 28px 0 0;
            max-height: 75dvh;
            display: flex;
            flex-direction: column;
            transition: transform 0.35s cubic-bezier(.32,.72,0,1);
            box-shadow: 0 -12px 50px rgba(0,0,0,0.6);
            padding-bottom: var(--safe-bottom);
        }
        .bottom-panel.collapsed {
            transform: translateY(calc(100% - 64px));
        }

        .panel-handle {
            flex-shrink: 0;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            touch-action: none;
            padding: 0 18px;
        }
        .handle-bar {
            width: 44px; height: 5px;
            background: var(--border);
            border-radius: 10px;
            transition: background 0.2s, width 0.2s;
            margin: 0 auto;
            position: absolute;
            left: 50%; transform: translateX(-50%);
        }
        .panel-handle:active .handle-bar { background: var(--green); width: 60px; }
        .panel-tab-label {
            font-size: 0.8rem;
            font-weight: 800;
            color: var(--text-dim);
            letter-spacing: 0.5px;
            text-transform: uppercase;
            pointer-events: none;
        }
        .bottom-panel:not(.collapsed) .panel-tab-label { display: none; }

        .panel-scroll {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
            padding: 0 12px calc(16px + var(--safe-bottom));
            overscroll-behavior: contain;
        }

        /* ‚îÄ‚îÄ CARDS ‚îÄ‚îÄ */
        .card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 16px;
            margin-bottom: 10px;
        }
        .card-title {
            font-size: 1rem;
            font-weight: 900;
            color: var(--green);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .step-badge {
            background: var(--green);
            color: #0a1a0c;
            font-size: 0.7rem;
            font-weight: 900;
            width: 24px; height: 24px;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            flex-shrink: 0;
        }

        .field-info {
            background: rgba(57,224,107,0.05);
            border: 1.5px dashed var(--border);
            border-radius: var(--radius-sm);
            padding: 14px;
            font-size: 0.9rem;
            color: var(--text-dim);
            font-weight: 600;
            line-height: 1.5;
            text-align: center;
        }
        .field-info.has-field {
            color: var(--green);
            border-style: solid;
            border-color: rgba(57,224,107,0.4);
            background: rgba(57,224,107,0.07);
            text-align: left;
        }

        .hint-tip {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            background: rgba(57,224,107,0.04);
            border-radius: var(--radius-sm);
            padding: 12px;
            margin-top: 10px;
            font-size: 0.85rem;
            color: var(--text-dim);
            line-height: 1.5;
        }
        .hint-tip .icon { font-size: 1.2rem; flex-shrink: 0; }

        .form-label {
            display: block;
            font-size: 0.78rem;
            font-weight: 800;
            color: var(--text-dim);
            margin: 14px 0 6px;
            text-transform: uppercase;
            letter-spacing: 0.8px;
        }
        .form-select {
            width: 100%;
            padding: 15px 42px 15px 15px;
            border-radius: var(--radius-sm);
            border: 1px solid var(--border);
            background: var(--surface);
            color: var(--text);
            font-family: 'Nunito', sans-serif;
            font-size: 1rem;
            font-weight: 700;
            outline: none;
            appearance: none;
            -webkit-appearance: none;
            cursor: pointer;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='22' height='22' viewBox='0 0 24 24' fill='%2339e06b'%3E%3Cpath d='M7 10l5 5 5-5z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 14px center;
            transition: border-color 0.2s;
        }
        .form-select:focus { border-color: var(--green); }

        .btn-analyze {
            width: 100%;
            padding: 18px;
            border-radius: var(--radius);
            border: none;
            background: linear-gradient(135deg, #39e06b, #1aaf45);
            color: #071209;
            font-family: 'Nunito', sans-serif;
            font-size: 1.05rem;
            font-weight: 900;
            cursor: pointer;
            margin-top: 14px;
            display: flex; align-items: center; justify-content: center; gap: 8px;
            transition: all 0.2s;
            box-shadow: 0 6px 24px rgba(57,224,107,0.25);
            position: relative;
            overflow: hidden;
            letter-spacing: -0.2px;
        }
        .btn-analyze::after {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, rgba(255,255,255,0.15), transparent);
        }
        .btn-analyze:active { transform: scale(0.97); box-shadow: 0 2px 10px rgba(57,224,107,0.15); }
        .btn-analyze:disabled { background: var(--green-dim); color: #3a5a3a; cursor: not-allowed; box-shadow: none; }
        .btn-analyze .spinner { width: 22px; height: 22px; border: 2.5px solid rgba(7,18,9,0.3); border-top-color: #071209; border-radius: 50%; animation: spin 0.7s linear infinite; display: none; }
        .btn-analyze.loading .spinner { display: block; }
        .btn-analyze.loading .btn-text { display: none; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Results */
        .results-card { display: none; }
        .results-card.visible { display: block; }

        .metrics-row {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 12px;
        }
        .metric {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            padding: 12px 6px;
            text-align: center;
        }
        .metric-val {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--green);
            line-height: 1;
        }
        .metric-val.warn { color: var(--amber); }
        .metric-val.danger { color: var(--red); }
        .metric-lbl { font-size: 0.68rem; color: var(--text-dim); font-weight: 800; text-transform: uppercase; margin-top: 5px; letter-spacing: 0.3px; }

        .source-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: rgba(57,224,107,0.08);
            border: 1px solid rgba(57,224,107,0.3);
            border-radius: 30px;
            padding: 6px 12px;
            font-size: 0.78rem;
            font-weight: 800;
            color: var(--green);
            margin-bottom: 12px;
        }

        .rec-box {
            background: rgba(255,183,77,0.05);
            border: 1px solid rgba(255,183,77,0.2);
            border-radius: var(--radius-sm);
            padding: 14px;
            font-size: 0.9rem;
            line-height: 1.7;
            white-space: pre-line;
            color: var(--text);
            max-height: 200px;
            overflow-y: auto;
        }

        .chart-wrap {
            position: relative;
            width: 100%;
            height: 150px;
            margin: 12px 0;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            padding: 10px;
        }

        .btn-download {
            width: 100%;
            padding: 16px;
            border-radius: var(--radius);
            border: 1.5px solid var(--blue);
            background: transparent;
            color: var(--blue);
            font-family: 'Nunito', sans-serif;
            font-size: 1rem;
            font-weight: 800;
            cursor: pointer;
            margin-top: 10px;
            transition: all 0.15s;
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .btn-download:active { background: rgba(77,208,225,0.1); transform: scale(0.98); }

        /* ‚îÄ‚îÄ LOADING OVERLAY ‚îÄ‚îÄ */
        .loading-overlay {
            display: none;
            position: absolute; inset: 0;
            background: rgba(10,26,12,0.85);
            backdrop-filter: blur(6px);
            -webkit-backdrop-filter: blur(6px);
            z-index: 999;
            flex-direction: column; align-items: center; justify-content: center;
            gap: 16px;
        }
        .loading-overlay.active { display: flex; }
        .loading-ring {
            width: 60px; height: 60px;
            border: 3px solid var(--border);
            border-top-color: var(--green);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        .loading-text {
            font-size: 0.95rem;
            font-weight: 700;
            color: var(--text-dim);
            text-align: center;
            padding: 0 20px;
        }

        /* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
        .toast {
            position: fixed;
            bottom: calc(var(--safe-bottom) + 80px);
            left: 50%;
            transform: translateX(-50%) translateY(16px);
            background: var(--card2);
            border: 1.5px solid var(--border);
            border-radius: 50px;
            padding: 12px 24px;
            font-size: 0.9rem;
            font-weight: 800;
            color: var(--text);
            opacity: 0;
            transition: opacity 0.25s, transform 0.25s;
            z-index: 1000;
            white-space: nowrap;
            pointer-events: none;
            box-shadow: 0 8px 30px rgba(0,0,0,0.5);
            max-width: calc(100vw - 32px);
            text-overflow: ellipsis;
            overflow: hidden;
        }
        .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
        .toast.success { border-color: rgba(57,224,107,0.5); color: var(--green); }
        .toast.error { border-color: rgba(255,82,82,0.5); color: var(--red); }

        /* ‚îÄ‚îÄ DESKTOP ‚îÄ‚îÄ */
        @media (min-width: 600px) {
            .bottom-panel {
                max-width: 400px;
                left: 14px;
                right: auto;
                bottom: 14px;
                border-radius: var(--radius);
                border: 1px solid var(--border);
                max-height: 85dvh;
                padding-bottom: 0;
            }
            .bottom-panel.collapsed {
                transform: translateY(calc(100% - 64px));
            }
            .layer-switcher { bottom: 32px; }
            .ndvi-legend { bottom: 160px; }
            .toast { bottom: 30px; }
        }

        /* ‚îÄ‚îÄ SCROLLBAR ‚îÄ‚îÄ */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
    </style>
</head>
<body>
<div id="app">
    <div id="map"></div>
  
    <!-- Loading overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-ring"></div>
        <div class="loading-text" id="loadingText">–ó–∞–ø—Ä–æ—Å –∫ —Å–ø—É—Ç–Ω–∏–∫–∞–º Copernicus...</div>
    </div>
  
    <!-- Toast -->
    <div class="toast" id="toast"></div>
  
    <!-- Top bar -->
    <div class="topbar">
        <div class="brand">
            <div class="brand-logo">üåø</div>
            <div>
                <div class="brand-title">–ê–≥—Ä–æ–ö–∞—Ä—Ç–∞ KG</div>
                <span class="brand-sub">–†–µ–∞–ª—å–Ω—ã–µ —Å–ø—É—Ç–Ω–∏–∫–∏</span>
            </div>
        </div>
        <div class="search-wrap">
            <div class="search-inner">
                <input class="search-input" id="searchInput" type="text" placeholder="–ü–æ–∏—Å–∫ –º–µ—Å—Ç–∞‚Ä¶" autocomplete="off" />
                <button class="search-btn" id="searchBtn">–ù–∞–π—Ç–∏</button>
            </div>
            <div class="search-dropdown" id="searchDropdown"></div>
        </div>
    </div>
  
    <!-- Layer switcher -->
    <div class="layer-switcher">
        <button class="layer-btn active" id="btnSatellite" onclick="switchLayer('satellite')">üõ∞ –°–ø—É—Ç–Ω–∏–∫</button>
        <button class="layer-btn" id="btnStreet" onclick="switchLayer('street')">üó∫ –ö–∞—Ä—Ç–∞</button>
    </div>
  
    <!-- NDVI legend -->
    <div class="ndvi-legend" id="ndviLegend">
        <div class="ndvi-legend-title">NDVI ‚Äî –∏–Ω–¥–µ–∫—Å —Ä–∞—Å—Ç–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏</div>
        <div class="legend-row"><div class="legend-dot" style="background:#2e7d32"></div><span>–û—Ç–ª–∏—á–Ω–æ ‚â• 0.70</span></div>
        <div class="legend-row"><div class="legend-dot" style="background:#7cb342"></div><span>–•–æ—Ä–æ—à–æ 0.55‚Äì0.70</span></div>
        <div class="legend-row"><div class="legend-dot" style="background:#fbc02d"></div><span>–°—Ä–µ–¥–Ω–µ 0.40‚Äì0.55</span></div>
        <div class="legend-row"><div class="legend-dot" style="background:#f57c00"></div><span>–ü–ª–æ—Ö–æ 0.25‚Äì0.40</span></div>
        <div class="legend-row"><div class="legend-dot" style="background:#d32f2f"></div><span>–ö—Ä–∏—Ç. &lt; 0.25</span></div>
    </div>
  
    <!-- Bottom panel -->
    <div class="bottom-panel collapsed" id="bottomPanel">
        <div class="panel-handle" id="panelHandle">
            <div class="handle-bar"></div>
            <span class="panel-tab-label">–ê–Ω–∞–ª–∏–∑ –ø–æ–ª—è ‚ñ≤</span>
        </div>
        <div class="panel-scroll" id="panelScroll">

            <!-- Step 1 -->
            <div class="card">
                <div class="card-title">
                    <span class="step-badge">1</span>
                    –ù–∞—Ä–∏—Å—É–π—Ç–µ –ø–æ–ª–µ
                </div>
                <div class="field-info" id="fieldInfo">–ü–æ–ª–µ –Ω–µ –Ω–∞—Ä–∏—Å–æ–≤–∞–Ω–æ</div>
                <div class="hint-tip">
                    <span class="icon">‚úèÔ∏è</span>
                    <span>–ù–∞–∂–º–∏—Ç–µ –∑–Ω–∞—á–æ–∫ –∫–∞—Ä–∞–Ω–¥–∞—à–∞ –Ω–∞ –∫–∞—Ä—Ç–µ, –∫–ª–∏–∫–∞–π—Ç–µ –ø–æ —É–≥–ª–∞–º –ø–æ–ª—è, –¥–≤–æ–π–Ω–æ–π –∫–ª–∏–∫ ‚Äî –∑–∞–≤–µ—Ä—à–∏—Ç—å.</span>
                </div>
            </div>

            <!-- Step 2 -->
            <div class="card">
                <div class="card-title">
                    <span class="step-badge">2</span>
                    –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∞–Ω–∞–ª–∏–∑–∞
                </div>
                <label class="form-label">–ö—É–ª—å—Ç—É—Ä–∞</label>
                <select class="form-select" id="cropSelect">
                    <option value="–ø—à–µ–Ω–∏—Ü–∞">üåæ –ü—à–µ–Ω–∏—Ü–∞</option>
                    <option value="–∫—É–∫—É—Ä—É–∑–∞">üåΩ –ö—É–∫—É—Ä—É–∑–∞</option>
                    <option value="—Ä–∏—Å">üçö –†–∏—Å</option>
                    <option value="–∫–∞—Ä—Ç–æ—Ñ–µ–ª—å">ü•î –ö–∞—Ä—Ç–æ—Ñ–µ–ª—å</option>
                    <option value="—Ö–ª–æ–ø–æ–∫">üå∏ –•–ª–æ–ø–æ–∫</option>
                    <option value="–ª—é—Ü–µ—Ä–Ω–∞">üåø –õ—é—Ü–µ—Ä–Ω–∞</option>
                    <option value="—Å–∞—Ö–∞—Ä–Ω–∞—è —Å–≤—ë–∫–ª–∞">ü´ö –°–∞—Ö–∞—Ä–Ω–∞—è —Å–≤—ë–∫–ª–∞</option>
                </select>
                <label class="form-label">–ü–µ—Ä–∏–æ–¥ –Ω–∞–±–ª—é–¥–µ–Ω–∏–π</label>
                <select class="form-select" id="periodSelect">
                    <option value="14">–ü–æ—Å–ª–µ–¥–Ω–∏–µ 14 –¥–Ω–µ–π</option>
                    <option value="30" selected>–ü–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π</option>
                    <option value="60">–ü–æ—Å–ª–µ–¥–Ω–∏–µ 60 –¥–Ω–µ–π</option>
                    <option value="90">–ü–æ—Å–ª–µ–¥–Ω–∏–µ 90 –¥–Ω–µ–π</option>
                </select>
                <button class="btn-analyze" id="analyzeBtn">
                    <div class="spinner"></div>
                    <span class="btn-text">üîç –ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª–µ</span>
                </button>
            </div>

            <!-- Step 3: Results -->
            <div class="card results-card" id="resultsCard">
                <div class="card-title">
                    <span class="step-badge">3</span>
                    –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞
                </div>
                <div class="source-badge" id="sourceBadge">üì° –ó–∞–≥—Ä—É–∑–∫–∞...</div>
                <div class="metrics-row">
                    <div class="metric">
                        <div class="metric-val" id="metricNdvi">‚Äî</div>
                        <div class="metric-lbl">NDVI</div>
                    </div>
                    <div class="metric">
                        <div class="metric-val" id="metricHealth">‚Äî</div>
                        <div class="metric-lbl">–°–æ—Å—Ç–æ—è–Ω–∏–µ</div>
                    </div>
                    <div class="metric">
                        <div class="metric-val" id="metricStress">‚Äî</div>
                        <div class="metric-lbl">–°—Ç—Ä–µ—Å—Å</div>
                    </div>
                </div>
                <div class="rec-box" id="recBox"></div>
                <div class="chart-wrap"><canvas id="timeChart"></canvas></div>
                <button class="btn-download" id="downloadBtn">üìÑ –°–∫–∞—á–∞—Ç—å –æ—Ç—á—ë—Ç (.txt)</button>
            </div>

        </div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>

<script>
    // ‚îÄ‚îÄ MAP INIT ‚îÄ‚îÄ
    const map = L.map('map', { zoomControl: false }).setView([41.2, 74.8], 7);
    L.control.zoom({ position: 'bottomright' }).addTo(map);
  
    const satelliteTile = L.tileLayer(
        'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
        { attribution: '¬© Esri', maxZoom: 19 }
    ).addTo(map);
  
    const streetTile = L.tileLayer(
        'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
        { attribution: '¬© OpenStreetMap', maxZoom: 19 }
    );
  
    const cartoLabels = L.tileLayer(
        'https://{s}.basemaps.cartocdn.com/dark_only_labels/{z}/{x}/{y}{r}.png',
        { subdomains: 'abcd', maxZoom: 19, opacity: 0.85 }
    ).addTo(map);
  
    window.switchLayer = function(type) {
        if (type === 'satellite') {
            map.removeLayer(streetTile);
            satelliteTile.addTo(map);
            cartoLabels.addTo(map);
            document.getElementById('btnSatellite').classList.add('active');
            document.getElementById('btnStreet').classList.remove('active');
        } else {
            map.removeLayer(satelliteTile);
            map.removeLayer(cartoLabels);
            streetTile.addTo(map);
            document.getElementById('btnStreet').classList.add('active');
            document.getElementById('btnSatellite').classList.remove('active');
        }
    };
  
    // ‚îÄ‚îÄ DRAW CONTROLS ‚îÄ‚îÄ
    const drawnItems = new L.FeatureGroup().addTo(map);
    const drawControl = new L.Control.Draw({
        position: 'topright',
        draw: {
            polygon: {
                allowIntersection: false,
                showArea: true,
                shapeOptions: { color: '#39e06b', weight: 2.5, fillOpacity: 0.14 }
            },
            rectangle: false, circle: false, marker: false,
            circlemarker: false, polyline: false
        },
        edit: { featureGroup: drawnItems, remove: true }
    });
    map.addControl(drawControl);
  
    let currentPolygon = null;
    let analysisData = null;
  
    map.on(L.Draw.Event.CREATED, function(e) {
        drawnItems.clearLayers();
        drawnItems.addLayer(e.layer);
        currentPolygon = e.layer.getLatLngs()[0].map(ll => [ll.lng, ll.lat]);
        const areaSqm = L.GeometryUtil.geodesicArea(e.layer.getLatLngs()[0]);
        const areaHa = (areaSqm / 10000).toFixed(1);
        const fi = document.getElementById('fieldInfo');
        fi.className = 'field-info has-field';
        fi.innerHTML = `‚úÖ –ü–æ–ª–µ –Ω–∞—Ä–∏—Å–æ–≤–∞–Ω–æ<br><small style="font-size:0.82rem;opacity:0.8">${currentPolygon.length} —Ç–æ—á–µ–∫ ¬∑ ~${areaHa} –≥–∞</small>`;
        document.getElementById('bottomPanel').classList.remove('collapsed');
        showToast('‚úÖ –ü–æ–ª–µ –Ω–∞—Ä–∏—Å–æ–≤–∞–Ω–æ ‚Äî ' + areaHa + ' –≥–∞', 'success');
    });
  
    map.on(L.Draw.Event.DELETED, function() {
        currentPolygon = null;
        analysisData = null;
        const fi = document.getElementById('fieldInfo');
        fi.className = 'field-info';
        fi.textContent = '–ü–æ–ª–µ –Ω–µ –Ω–∞—Ä–∏—Å–æ–≤–∞–Ω–æ';
        document.getElementById('resultsCard').classList.remove('visible');
        document.getElementById('ndviLegend').classList.remove('visible');
        removeOverlays();
    });
  
    // ‚îÄ‚îÄ SEARCH ‚îÄ‚îÄ
    const searchInput = document.getElementById('searchInput');
    const searchBtn = document.getElementById('searchBtn');
    const dropdown = document.getElementById('searchDropdown');
    let searchMarker = null;
  
    function doSearch() {
        const q = searchInput.value.trim();
        if (!q) return;
        dropdown.innerHTML = '<div class="search-item">‚è≥ –ü–æ–∏—Å–∫‚Ä¶</div>';
        dropdown.classList.add('active');
        const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}&limit=10&accept-language=ru,ky&addressdetails=1`;
        fetch(url, { headers: { 'User-Agent': 'AgroKG-App/3.0' } })
            .then(r => r.json())
            .then(items => {
                if (!items.length) {
                    dropdown.innerHTML = '<div class="search-item">‚ùå –ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>';
                    return;
                }
                dropdown.innerHTML = items.map(it => {
                    const short = it.display_name.split(',').slice(0, 3).join(', ');
                    return `<div class="search-item" data-lat="${it.lat}" data-lon="${it.lon}" data-name="${it.display_name}">${short}</div>`;
                }).join('');
                dropdown.querySelectorAll('.search-item[data-lat]').forEach(el => {
                    el.addEventListener('click', () => {
                        const lat = parseFloat(el.dataset.lat);
                        const lon = parseFloat(el.dataset.lon);
                        if (searchMarker) map.removeLayer(searchMarker);
                        searchMarker = L.circleMarker([lat, lon], {
                            radius: 9, fillColor: '#39e06b', color: '#0a1a0c', weight: 2, fillOpacity: 0.9
                        }).addTo(map).bindPopup(`<b>${el.dataset.name.split(',')[0]}</b>`).openPopup();
                        map.setView([lat, lon], 13);
                        dropdown.classList.remove('active');
                        searchInput.blur();
                        document.getElementById('bottomPanel').classList.remove('collapsed');
                    });
                });
            })
            .catch(() => {
                dropdown.innerHTML = '<div class="search-item">‚ö†Ô∏è –û—à–∏–±–∫–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ.</div>';
            });
    }
  
    searchBtn.addEventListener('click', doSearch);
    searchInput.addEventListener('keydown', e => { if (e.key === 'Enter') { doSearch(); searchInput.blur(); } });
    document.addEventListener('click', e => {
        if (!dropdown.contains(e.target) && e.target !== searchInput && e.target !== searchBtn) {
            dropdown.classList.remove('active');
        }
    });
  
    // ‚îÄ‚îÄ ANALYZE ‚îÄ‚îÄ
    document.getElementById('analyzeBtn').addEventListener('click', function() {
        if (!currentPolygon) {
            showToast('‚ùå –°–Ω–∞—á–∞–ª–∞ –Ω–∞—Ä–∏—Å—É–π—Ç–µ –ø–æ–ª–µ!', 'error');
            return;
        }
        const btn = this;
        btn.classList.add('loading');
        btn.disabled = true;
        const overlay = document.getElementById('loadingOverlay');
        overlay.classList.add('active');
        document.getElementById('loadingText').textContent = 'üì° –ó–∞–ø—Ä–æ—Å –∫ —Å–ø—É—Ç–Ω–∏–∫–∞–º Copernicus...';
  
        const crop = document.getElementById('cropSelect').value;
        const period = parseInt(document.getElementById('periodSelect').value);
  
        fetch('/api/analyze', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ polygon: currentPolygon, crop, period })
        })
        .then(r => { if (!r.ok) throw new Error(`HTTP ${r.status}`); return r.json(); })
        .then(data => {
            analysisData = data;
            displayResults(data);
            showToast('‚úÖ –ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à—ë–Ω!', 'success');
        })
        .catch(err => {
            console.error(err);
            showToast('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–µ—Ä–≤–µ—Ä.', 'error');
        })
        .finally(() => {
            btn.classList.remove('loading');
            btn.disabled = false;
            overlay.classList.remove('active');
        });
    });
  
    // ‚îÄ‚îÄ DISPLAY RESULTS ‚îÄ‚îÄ
    function removeOverlays() {
        map.eachLayer(l => { if (l._isAgroOverlay) map.removeLayer(l); });
    }
  
    function displayResults(data) {
        const { summary, recommendation, health_grid, stress_zones, time_series, forecast, data_source } = data;
        const ndviEl = document.getElementById('metricNdvi');
        const healthEl = document.getElementById('metricHealth');
        const stressEl = document.getElementById('metricStress');
  
        ndviEl.textContent = summary.avg_ndvi.toFixed(2);
        healthEl.textContent = summary.health;
        stressEl.textContent = summary.stress_percent.toFixed(0) + '%';
        ndviEl.className = 'metric-val' + (summary.avg_ndvi < 0.35 ? ' danger' : summary.avg_ndvi < 0.5 ? ' warn' : '');
        stressEl.className = 'metric-val' + (summary.stress_percent > 30 ? ' danger' : summary.stress_percent > 15 ? ' warn' : '');
  
        const srcBadge = document.getElementById('sourceBadge');
        srcBadge.textContent = 'üì° ' + (data_source || '–†–µ–∞–ª—å–Ω—ã–µ —Å–ø—É—Ç–Ω–∏–∫–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ');
  
        document.getElementById('recBox').textContent = recommendation;
  
        const ctx = document.getElementById('timeChart').getContext('2d');
        if (window._chart) window._chart.destroy();
        const allDates = [...time_series.dates, ...forecast.dates];
        const histVals = [...time_series.values, ...new Array(forecast.dates.length).fill(null)];
        const fcastVals = [...new Array(time_series.values.length - 1).fill(null),
            time_series.values[time_series.values.length - 1], ...forecast.values];
        window._chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: allDates,
                datasets: [
                    { label: 'NDVI (—Ñ–∞–∫—Ç)', data: histVals, borderColor: '#39e06b', backgroundColor: 'rgba(57,224,107,0.08)', fill: true, tension: 0.35, pointRadius: 0, borderWidth: 2 },
                    { label: '–ü—Ä–æ–≥–Ω–æ–∑', data: fcastVals, borderColor: '#ffb74d', borderDash: [5, 4], fill: false, tension: 0.35, pointRadius: 2, borderWidth: 1.5, pointBackgroundColor: '#ffb74d' }
                ]
            },
            options: {
                responsive: true, maintainAspectRatio: false, animation: { duration: 600 },
                plugins: { legend: { labels: { color: '#6a8f6a', font: { size: 11, family: 'Nunito', weight: '700' }, boxWidth: 14 } } },
                scales: {
                    x: { ticks: { color: '#3d5e3d', maxRotation: 0, maxTicksLimit: 5, font: { size: 10, family: 'JetBrains Mono' } }, grid: { color: 'rgba(36,56,40,0.6)' } },
                    y: { min: 0, max: 1, ticks: { color: '#3d5e3d', font: { size: 10, family: 'JetBrains Mono' } }, grid: { color: 'rgba(36,56,40,0.6)' } }
                }
            }
        });
  
        removeOverlays();
        const healthLayer = L.geoJSON(health_grid, {
            style: f => ({ color: f.properties.color, weight: 0.5, fillColor: f.properties.color, fillOpacity: 0.45 }),
            onEachFeature: (f, l) => { l._isAgroOverlay = true; l.bindTooltip(`NDVI: ${f.properties.ndvi.toFixed(2)} (${f.properties.health})`, { sticky: true }); }
        }).addTo(map);
        healthLayer.eachLayer(l => { l._isAgroOverlay = true; });
        healthLayer._isAgroOverlay = true;
        if (stress_zones?.features?.length) {
            const sl = L.geoJSON(stress_zones, { style: { color: '#ff5252', weight: 2.5, dashArray: '6,5', fillOpacity: 0 } }).addTo(map);
            sl.eachLayer(l => { l._isAgroOverlay = true; l.bindTooltip('‚ö†Ô∏è –ó–æ–Ω–∞ —Å—Ç—Ä–µ—Å—Å–∞'); });
            sl._isAgroOverlay = true;
        }
  
        document.getElementById('ndviLegend').classList.add('visible');
        document.getElementById('resultsCard').classList.add('visible');
        setTimeout(() => { document.getElementById('resultsCard').scrollIntoView({ behavior: 'smooth', block: 'start' }); }, 300);
        if (drawnItems.getLayers().length) map.fitBounds(drawnItems.getBounds(), { padding: [40, 40] });
    }
  
    // ‚îÄ‚îÄ DOWNLOAD ‚îÄ‚îÄ
    document.getElementById('downloadBtn').addEventListener('click', function() {
        if (!analysisData) return;
        const d = analysisData;
        const date = new Date().toLocaleString('ru-RU');
        const crop = document.getElementById('cropSelect').value;
        const text = [
            '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê',
            '    –û–¢–ß–Å–¢ –ú–û–ù–ò–¢–û–†–ò–ù–ì–ê –ü–û–õ–Ø ‚Äî –ê–≥—Ä–æ–ö–∞—Ä—Ç–∞ KG',
            '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê',
            `–î–∞—Ç–∞:            ${date}`,
            `–ö—É–ª—å—Ç—É—Ä–∞:        ${crop}`,
            `–ò—Å—Ç–æ—á–Ω–∏–∫ –¥–∞–Ω–Ω—ã—Ö: ${d.data_source || '–°–ø—É—Ç–Ω–∏–∫–∏ Copernicus'}`,
            '',
            '‚îÄ‚îÄ –ü–û–ö–ê–ó–ê–¢–ï–õ–ò ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ',
            `–°—Ä–µ–¥–Ω–∏–π NDVI:    ${d.summary.avg_ndvi.toFixed(2)}`,
            `–°–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ–ª—è:  ${d.summary.health}`,
            `–ó–æ–Ω–∞ —Å—Ç—Ä–µ—Å—Å–∞:    ${d.summary.stress_percent.toFixed(0)}% –ø–ª–æ—â–∞–¥–∏`,
            `–¶–µ–Ω—Ç—Ä –ø–æ–ª—è:      ${d.summary.center?.lat.toFixed(4)}, ${d.summary.center?.lon.toFixed(4)}`,
            '',
            '‚îÄ‚îÄ –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ',
            d.recommendation,
            '',
            '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê',
            '–°–æ–∑–¥–∞–Ω–æ: –ê–≥—Ä–æ–ö–∞—Ä—Ç–∞ KG ‚Äî —Ä–µ–∞–ª—å–Ω—ã–µ —Å–ø—É—Ç–Ω–∏–∫–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ',
        ].join('\n');
        const blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = `agro_report_${Date.now()}.txt`; a.click();
        URL.revokeObjectURL(url);
        showToast('üì• –û—Ç—á—ë—Ç —Å–∫–∞—á–∞–Ω', 'success');
    });
  
    // ‚îÄ‚îÄ PANEL DRAG ‚îÄ‚îÄ
    const bottomPanel = document.getElementById('bottomPanel');
    const panelHandle = document.getElementById('panelHandle');
    let dragStartY = 0, isDragging = false;
  
    panelHandle.addEventListener('touchstart', e => {
        dragStartY = e.touches[0].clientY;
        isDragging = true;
    }, { passive: true });
    panelHandle.addEventListener('touchmove', e => {
        if (!isDragging) return;
        const dy = Math.max(0, Math.min(400, e.touches[0].clientY - dragStartY));
        bottomPanel.style.transition = 'none';
        bottomPanel.style.transform = `translateY(${dy}px)`;
    }, { passive: true });
    panelHandle.addEventListener('touchend', () => {
        if (!isDragging) return;
        isDragging = false;
        bottomPanel.style.transition = '';
        const m = bottomPanel.style.transform.match(/translateY\((\d+(?:\.\d+)?)px\)/);
        const dy = m ? parseFloat(m[1]) : 0;
        bottomPanel.style.transform = '';
        if (dy > 90) bottomPanel.classList.add('collapsed');
        else bottomPanel.classList.remove('collapsed');
    });
    panelHandle.addEventListener('click', () => bottomPanel.classList.toggle('collapsed'));
  
    if (window.innerWidth >= 600) bottomPanel.classList.remove('collapsed');
  
    // ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ
    let toastTimer = null;
    function showToast(msg, type = '') {
        const t = document.getElementById('toast');
        t.textContent = msg;
        t.className = 'toast ' + type + ' show';
        if (toastTimer) clearTimeout(toastTimer);
        toastTimer = setTimeout(() => { t.className = 'toast'; }, 2800);
    }
</script>
</body>
</html>